<!--
  Accessibility Toolbar Component
  Provides user controls for accessibility preferences
  
  Features:
  - High contrast mode toggle
  - Text size adjustment
  - Dyslexia-friendly font toggle
  - Reading guide toggle
  - Reduced motion toggle
  
  To enable by default, add ?a11y-tools to URL or set site.accessibility.toolbar: true
-->

{% assign show_toolbar = site.accessibility.toolbar | default: false %}

<aside 
  class="a11y-toolbar" 
  id="a11y-toolbar"
  role="region"
  aria-label="Accessibility options"
  {% unless show_toolbar %}hidden{% endunless %}
>
  <button 
    type="button"
    class="a11y-toolbar__toggle"
    id="a11y-toolbar-toggle"
    aria-expanded="false"
    aria-controls="a11y-toolbar-panel"
    aria-label="Open accessibility options"
  >
    <svg aria-hidden="true" focusable="false" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <circle cx="12" cy="12" r="3"/>
      <path d="M12 2v2m0 16v2M2 12h2m16 0h2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"/>
    </svg>
    <span class="sr-only">Accessibility</span>
  </button>

  <div 
    class="a11y-toolbar__panel" 
    id="a11y-toolbar-panel"
    role="group"
    aria-label="Accessibility settings"
    hidden
  >
    <h3 class="a11y-toolbar__title">Accessibility Options</h3>

    <!-- Read Aloud (Text-to-Speech) -->
    <button 
      type="button"
      class="a11y-toolbar__btn"
      id="a11y-tts"
      aria-pressed="false"
      onclick="a11yToggleTextToSpeech(); this.setAttribute('aria-pressed', document.documentElement.hasAttribute('data-tts-active'))"
    >
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
      </svg>
      <span>Read Aloud</span>
    </button>

    <!-- Stop Reading -->
    <button 
      type="button"
      class="a11y-toolbar__btn"
      id="a11y-tts-stop"
      onclick="a11yStopReading()"
    >
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <rect x="6" y="6" width="12" height="12" rx="2"/>
      </svg>
      <span>Stop Reading</span>
    </button>

    <!-- High Contrast -->
    <button 
      type="button"
      class="a11y-toolbar__btn"
      id="a11y-contrast"
      aria-pressed="false"
      onclick="a11yToggleHighContrast()"
    >
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
        <path d="M12 2a10 10 0 0 1 0 20V2z"/>
      </svg>
      <span>High Contrast</span>
    </button>

    <!-- Text Size -->
    <button 
      type="button"
      class="a11y-toolbar__btn"
      id="a11y-textsize"
      aria-pressed="false"
      onclick="a11yToggleTextSize()"
    >
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <text x="3" y="20" font-size="12" fill="currentColor">A</text>
        <text x="14" y="18" font-size="16" fill="currentColor">A</text>
      </svg>
      <span>Larger Text</span>
    </button>

    <!-- Dyslexia Font -->
    <button 
      type="button"
      class="a11y-toolbar__btn"
      id="a11y-dyslexia"
      aria-pressed="false"
      onclick="a11yToggleDyslexiaFont()"
    >
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
      </svg>
      <span>Dyslexia Font</span>
    </button>

    <!-- Reading Guide -->
    <button 
      type="button"
      class="a11y-toolbar__btn"
      id="a11y-guide"
      aria-pressed="false"
      onclick="a11yToggleReadingGuide()"
    >
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="10" width="18" height="4" rx="1"/>
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
      <span>Reading Guide</span>
    </button>

    <!-- Keyboard Shortcuts Help -->
    <button
      type="button"
      class="a11y-toolbar__btn"
      aria-haspopup="dialog"
      onclick="showKeyboardHelp()"
    >
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="6" width="20" height="12" rx="2"/>
        <line x1="6" y1="10" x2="6" y2="10"/>
        <line x1="10" y1="10" x2="10" y2="10"/>
        <line x1="14" y1="10" x2="14" y2="10"/>
        <line x1="18" y1="10" x2="18" y2="10"/>
        <line x1="8" y1="14" x2="16" y2="14"/>
      </svg>
      <span>Keyboard Help</span>
    </button>

    <p class="a11y-toolbar__note">
      <small>Settings are saved for your next visit</small>
    </p>
  </div>
</aside>

<!-- Keyboard Shortcuts Dialog -->
<dialog 
  class="a11y-keyboard-dialog" 
  id="keyboard-help-dialog"
  aria-labelledby="keyboard-dialog-title"
>
  <header>
    <h2 id="keyboard-dialog-title">Keyboard Shortcuts</h2>
    <button 
      type="button" 
      class="dialog-close" 
      aria-label="Close keyboard shortcuts"
      onclick="document.getElementById('keyboard-help-dialog').close()"
    >
      ×
    </button>
  </header>
  
  <div class="keyboard-shortcuts">
    <h3>Navigation</h3>
    <dl>
      <dt><kbd>Tab</kbd></dt>
      <dd>Move to next interactive element</dd>
      
      <dt><kbd>Shift</kbd> + <kbd>Tab</kbd></dt>
      <dd>Move to previous interactive element</dd>
      
      <dt><kbd>Enter</kbd> or <kbd>Space</kbd></dt>
      <dd>Activate buttons and links</dd>
      
      <dt><kbd>Escape</kbd></dt>
      <dd>Close dialogs and menus</dd>
      
      <dt><kbd>↑</kbd> <kbd>↓</kbd></dt>
      <dd>Navigate menu items</dd>
      
      <dt><kbd>Home</kbd></dt>
      <dd>Go to first item in list</dd>
      
      <dt><kbd>End</kbd></dt>
      <dd>Go to last item in list</dd>
    </dl>

    <h3>Skip Links</h3>
    <p>Press <kbd>Tab</kbd> on page load to reveal skip links for quick navigation.</p>
  </div>

  <footer>
    <button type="button" onclick="document.getElementById('keyboard-help-dialog').close()">
      Close
    </button>
  </footer>
</dialog>

<script>
(function() {
  // Toolbar toggle
  const toggle = document.getElementById('a11y-toolbar-toggle');
  const panel = document.getElementById('a11y-toolbar-panel');
  
  if (toggle && panel) {
    toggle.addEventListener('click', function() {
      const expanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !expanded);
      panel.hidden = expanded;
      
      if (!expanded) {
        panel.querySelector('button').focus();
      }
    });

    // Close on escape
    panel.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        toggle.setAttribute('aria-expanded', 'false');
        panel.hidden = true;
        toggle.focus();
      }
    });
  }

  // Show toolbar if URL param present
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('a11y-tools') || urlParams.has('accessibility')) {
    document.getElementById('a11y-toolbar').hidden = false;
  }

  // Keyboard shortcuts dialog
  window.showKeyboardHelp = function() {
    const dialog = document.getElementById('keyboard-help-dialog');
    if (dialog && dialog.showModal) {
      dialog.showModal();
    }
  };

  // Update button states from preferences
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const prefs = JSON.parse(localStorage.getItem('tillerstead-a11y-prefs') || '{}');
      
      if (prefs.highContrast) {
        document.getElementById('a11y-contrast')?.setAttribute('aria-pressed', 'true');
      }
      if (prefs.textSize && prefs.textSize !== 'normal') {
        document.getElementById('a11y-textsize')?.setAttribute('aria-pressed', 'true');
      }
      if (prefs.dyslexiaFont) {
        document.getElementById('a11y-dyslexia')?.setAttribute('aria-pressed', 'true');
      }
      if (prefs.readingGuide) {
        document.getElementById('a11y-guide')?.setAttribute('aria-pressed', 'true');
      }
      if (prefs.showToolbar) {
        document.getElementById('a11y-toolbar').hidden = false;
      }
    } catch (e) {
      // localStorage not available
    }
  });
})();
</script>

<style>
/* Accessibility Toolbar Styles */
.a11y-toolbar {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  z-index: 9999;
  font-family: system-ui, -apple-system, sans-serif;
}

.a11y-toolbar__toggle {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--tiller-color-primary, #1a2a3a);
  color: #fff;
  border: 2px solid transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  transition: transform 0.2s, background 0.2s;
}

.a11y-toolbar__toggle:hover,
.a11y-toolbar__toggle:focus {
  transform: scale(1.1);
  background: var(--tiller-color-gold, #c9a227);
  color: #000;
}

.a11y-toolbar__toggle:focus-visible {
  outline: 3px solid var(--tiller-color-gold, #c9a227);
  outline-offset: 3px;
}

.a11y-toolbar__panel {
  position: absolute;
  bottom: 60px;
  right: 0;
  width: 220px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  padding: 1rem;
}

.a11y-toolbar__title {
  font-size: 0.875rem;
  font-weight: 700;
  margin: 0 0 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #eee;
  color: var(--tiller-color-primary, #1a2a3a);
}

.a11y-toolbar__btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
  padding: 0.625rem;
  margin-bottom: 0.375rem;
  border: 2px solid transparent;
  border-radius: 6px;
  background: #f5f5f5;
  color: #333;
  font-size: 0.875rem;
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s;
}

.a11y-toolbar__btn:hover {
  background: #e5e5e5;
}

.a11y-toolbar__btn:focus-visible {
  outline: none;
  border-color: var(--tiller-color-gold, #c9a227);
  box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.25);
}

.a11y-toolbar__btn[aria-pressed="true"] {
  background: var(--tiller-color-gold, #c9a227);
  color: #000;
  font-weight: 600;
}

.a11y-toolbar__note {
  margin: 0.5rem 0 0;
  color: #666;
  font-size: 0.75rem;
  text-align: center;
}

/* Keyboard Help Dialog */
.a11y-keyboard-dialog {
  max-width: 500px;
  padding: 1.5rem;
  border: none;
  border-radius: 12px;
  box-shadow: 0 12px 36px rgba(0, 0, 0, 0.2);
}

.a11y-keyboard-dialog::backdrop {
  background: rgba(0, 0, 0, 0.5);
}

.a11y-keyboard-dialog header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #eee;
}

.a11y-keyboard-dialog h2 {
  margin: 0;
  font-size: 1.25rem;
}

.dialog-close {
  width: 36px;
  height: 36px;
  border: none;
  background: #f0f0f0;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.dialog-close:hover,
.dialog-close:focus {
  background: #e0e0e0;
}

.keyboard-shortcuts dl {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 0.5rem 1rem;
  margin: 0.5rem 0 1rem;
}

.keyboard-shortcuts dt {
  font-weight: normal;
}

.keyboard-shortcuts dd {
  margin: 0;
  color: #555;
}

.keyboard-shortcuts kbd {
  display: inline-block;
  padding: 0.2em 0.5em;
  font-family: monospace;
  font-size: 0.875em;
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.keyboard-shortcuts h3 {
  font-size: 1rem;
  margin: 1rem 0 0.5rem;
  color: var(--tiller-color-primary, #1a2a3a);
}

.a11y-keyboard-dialog footer {
  margin-top: 1rem;
  padding-top: 0.75rem;
  border-top: 1px solid #eee;
  text-align: right;
}

.a11y-keyboard-dialog footer button {
  padding: 0.5rem 1.5rem;
  background: var(--tiller-color-primary, #1a2a3a);
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.875rem;
}

.a11y-keyboard-dialog footer button:hover,
.a11y-keyboard-dialog footer button:focus {
  background: var(--tiller-color-gold, #c9a227);
  color: #000;
}

/* High contrast mode adjustments for toolbar */
[data-high-contrast="true"] .a11y-toolbar__panel {
  background: #000;
  border: 2px solid #fff;
}

[data-high-contrast="true"] .a11y-toolbar__title {
  color: #fff;
  border-bottom-color: #fff;
}

[data-high-contrast="true"] .a11y-toolbar__btn {
  background: #333;
  color: #fff;
  border-color: #fff;
}

[data-high-contrast="true"] .a11y-toolbar__btn[aria-pressed="true"] {
  background: #ffff00;
  color: #000;
}

@media (prefers-reduced-motion: reduce) {
  .a11y-toolbar__toggle {
    transition: none;
  }
}
</style>
