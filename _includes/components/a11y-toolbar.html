<!--
  Accessibility Toolbar Component
  Provides user controls for accessibility preferences
  
  Features:
  - High contrast mode toggle
  - Text size adjustment
  - Dyslexia-friendly font toggle
  - Reading guide toggle
  - Reduced motion toggle
  
  To enable by default, add ?a11y-tools to URL or set site.accessibility.toolbar: true
-->

{% assign show_toolbar = site.accessibility.toolbar | default: false %}

<aside
  class="a11y-toolbar"
  id="a11y-toolbar"
  role="region"
  aria-label="Accessibility options"
  hidden
>
  <button
    type="button"
    class="a11y-toolbar__toggle"
    id="a11y-toolbar-toggle"
    aria-expanded="false"
    aria-controls="a11y-toolbar-panel"
    aria-label="Open accessibility options"
  >
    <svg
      aria-hidden="true"
      focusable="false"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <circle cx="12" cy="12" r="10" />
      <circle cx="12" cy="12" r="3" />
      <path
        d="M12 2v2m0 16v2M2 12h2m16 0h2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"
      />
    </svg>
    <span class="sr-only">Accessibility</span>
  </button>

  <div class="a11y-toolbar__panel" id="a11y-toolbar-panel" role="group" aria-label="Accessibility settings" hidden>
    <h3 class="a11y-toolbar__title">Accessibility Options</h3>

    <!-- Read Aloud (Text-to-Speech) -->
    <button type="button" class="a11y-toolbar__btn" id="a11y-tts" aria-pressed="false">
      <svg
        aria-hidden="true"
        focusable="false"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
      </svg>
      <span>Read Aloud</span>
    </button>

    <!-- Stop Reading -->
    <button type="button" class="a11y-toolbar__btn" id="a11y-tts-stop">
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <rect x="6" y="6" width="12" height="12" rx="2" />
      </svg>
      <span>Stop Reading</span>
    </button>

    <!-- High Contrast -->
    <button type="button" class="a11y-toolbar__btn" id="a11y-contrast" aria-pressed="false">
      <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
        <path d="M12 2a10 10 0 0 1 0 20V2z" />
      </svg>
      <span>High Contrast</span>
    </button>

    <!-- Text Size -->
    <button type="button" class="a11y-toolbar__btn" id="a11y-textsize" aria-pressed="false">
      <svg
        aria-hidden="true"
        focusable="false"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <text x="3" y="20" font-size="12" fill="currentColor">A</text>
        <text x="14" y="18" font-size="16" fill="currentColor">A</text>
      </svg>
      <span>Larger Text</span>
    </button>

    <!-- Scroll to Top -->
    <button type="button" class="a11y-toolbar__btn" id="a11y-scroll-top">
      <svg
        aria-hidden="true"
        focusable="false"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M18 15l-6-6-6 6" />
      </svg>
      <span>Back to Top</span>
    </button>

    <!-- Custom Cursor -->
    <button type="button" class="a11y-toolbar__btn" id="a11y-cursor" aria-pressed="false">
      <svg
        aria-hidden="true"
        focusable="false"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="12" cy="12" r="8" />
        <circle cx="12" cy="12" r="3" />
      </svg>
      <span>Fancy Cursor</span>
    </button>

    <!-- Free Quote CTA -->
    <a href="/contact/" class="a11y-toolbar__btn a11y-toolbar__cta" id="a11y-quote">
      <svg
        aria-hidden="true"
        focusable="false"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
      </svg>
      <span>Free Quote</span>
    </a>

    <p class="a11y-toolbar__note">
      <small>Settings are saved for your next visit</small>
    </p>
  </div>
</aside>

<script defer>
  (function () {
    const toolbar = document.getElementById('a11y-toolbar');
    const toggle = document.getElementById('a11y-toolbar-toggle');
    const panel = document.getElementById('a11y-toolbar-panel');

    if (!toolbar || !toggle || !panel) return;

    const buttons = {
      tts: document.getElementById('a11y-tts'),
      ttsStop: document.getElementById('a11y-tts-stop'),
      contrast: document.getElementById('a11y-contrast'),
      textSize: document.getElementById('a11y-textsize'),
      scrollTop: document.getElementById('a11y-scroll-top'),
      cursor: document.getElementById('a11y-cursor'),
    };

    // Event Listeners
    toggle.addEventListener('click', () => {
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
      toggle.setAttribute('aria-expanded', !isExpanded);
      panel.hidden = isExpanded;
      if (!isExpanded) {
        panel.querySelector('button').focus();
      }
    });

    panel.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        toggle.setAttribute('aria-expanded', 'false');
        panel.hidden = true;
        toggle.focus();
      }
    });

    buttons.tts?.addEventListener('click', function () {
      if (typeof a11yToggleTextToSpeech === 'function') {
        a11yToggleTextToSpeech();
        this.setAttribute('aria-pressed', document.documentElement.hasAttribute('data-tts-active'));
      }
    });

    buttons.ttsStop?.addEventListener('click', () => {
      if (typeof a11yStopReading === 'function') {
        a11yStopReading();
      }
    });

    buttons.contrast?.addEventListener('click', () => {
      if (typeof a11yToggleHighContrast === 'function') a11yToggleHighContrast();
    });

    buttons.textSize?.addEventListener('click', () => {
      if (typeof a11yToggleTextSize === 'function') a11yToggleTextSize();
    });

    buttons.cursor?.addEventListener('click', () => {
      if (typeof a11yToggleCustomCursor === 'function') a11yToggleCustomCursor();
    });

    buttons.scrollTop?.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'auto' : 'smooth',
      });
      buttons.scrollTop.blur();
    });

    // Initialize
    function applyPreferences() {
      try {
        const prefs = JSON.parse(localStorage.getItem('tillerstead-a11y-prefs') || '{}');
        if (prefs.highContrast) buttons.contrast?.setAttribute('aria-pressed', 'true');
        if (prefs.textSize && prefs.textSize !== 'normal') buttons.textSize?.setAttribute('aria-pressed', 'true');
        if (prefs.customCursor) buttons.cursor?.setAttribute('aria-pressed', 'true');
        if (prefs.showToolbar) toolbar.hidden = false;
      } catch (e) {
        console.error('Could not apply accessibility preferences from localStorage.', e);
      }
    }

    function showToolbarOnParam() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('a11y-tools') || urlParams.has('accessibility')) {
        toolbar.hidden = false;
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyPreferences);
    } else {
      applyPreferences();
    }

    showToolbarOnParam();
  })();
</script>

<style>
  /* Accessibility Toolbar Styles */
  .a11y-toolbar {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    z-index: 9999;
    font-family: system-ui, -apple-system, sans-serif;
    pointer-events: none;
  }

  .a11y-toolbar[hidden] {
    display: none;
  }

  .a11y-toolbar__toggle {
    pointer-events: auto;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--tiller-color-primary, #1a2a3a), #2a3a4a);
    color: #fff;
    border: 2px solid rgba(201, 162, 39, 0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      0 4px 16px rgba(0, 0, 0, 0.3),
      0 0 20px rgba(16, 185, 129, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
  }

  .a11y-toolbar__toggle svg {
    transition: transform 0.3s ease;
  }

  .a11y-toolbar__toggle:hover,
  .a11y-toolbar__toggle:focus-visible {
    transform: translateY(-2px) scale(1.05);
    background: linear-gradient(135deg, var(--tiller-color-gold, #c9a227), var(--tiller-color-gold-dark, #9a7a1a));
    color: #000;
    border-color: rgba(201, 162, 39, 0.6);
    box-shadow:
      0 6px 20px rgba(0, 0, 0, 0.4),
      0 0 30px rgba(201, 162, 39, 0.4);
  }

  .a11y-toolbar__toggle:hover svg {
    transform: rotate(90deg);
  }

  .a11y-toolbar__toggle:active {
    transform: translateY(0) scale(0.98);
  }

  .a11y-toolbar__toggle:focus-visible {
    outline: 3px solid var(--tiller-color-gold, #c9a227);
    outline-offset: 4px;
  }

  .a11y-toolbar__panel {
    pointer-events: auto;
    position: absolute;
    bottom: calc(100% + 0.5rem);
    right: 0;
    width: 240px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .a11y-toolbar__title {
    font-size: 0.875rem;
    font-weight: 700;
    margin: 0 0 0.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
    color: var(--tiller-color-primary, #1a2a3a);
  }

  .a11y-toolbar__btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.625rem;
    border: 2px solid transparent;
    border-radius: 6px;
    background: #f5f5f5;
    color: #333;
    font-size: 0.875rem;
    text-align: left;
    cursor: pointer;
    transition:
      background 0.2s,
      border-color 0.2s;
  }

  .a11y-toolbar__btn:hover {
    background: #e5e5e5;
  }

  .a11y-toolbar__btn:focus-visible {
    outline: none;
    border-color: var(--tiller-color-gold, #c9a227);
    box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.25);
  }

  .a11y-toolbar__btn[aria-pressed='true'] {
    background: var(--tiller-color-gold, #c9a227);
    color: #000;
    font-weight: 600;
  }

  /* Free Quote CTA Button - standout styling */
  .a11y-toolbar__cta {
    background: linear-gradient(
      135deg,
      var(--tiller-color-emerald, #10b981),
      var(--tiller-color-emerald-dark, #059669)
    );
    color: #fff;
    font-weight: 600;
    text-decoration: none;
    border: none;
    margin-top: 0.25rem;
  }

  .a11y-toolbar__cta:hover,
  .a11y-toolbar__cta:focus-visible {
    background: linear-gradient(135deg, var(--tiller-color-gold, #c9a227), var(--tiller-color-gold-dark, #9a7a1a));
    color: #000;
  }

  .a11y-toolbar__note {
    margin: 0.25rem 0 0;
    color: #666;
    font-size: 0.75rem;
    text-align: center;
  }

  /* High contrast mode adjustments for toolbar */
  [data-high-contrast='true'] .a11y-toolbar__panel {
    background: #000;
    border: 2px solid #fff;
  }

  [data-high-contrast='true'] .a11y-toolbar__title {
    color: #fff;
    border-bottom-color: #fff;
  }

  [data-high-contrast='true'] .a11y-toolbar__btn {
    background: #333;
    color: #fff;
    border-color: #fff;
  }

  [data-high-contrast='true'] .a11y-toolbar__btn[aria-pressed='true'] {
    background: #ffff00;
    color: #000;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .a11y-toolbar {
      bottom: 0.75rem;
      right: 0.75rem;
    }

    .a11y-toolbar__toggle {
      width: 48px;
      height: 48px;
    }

    .a11y-toolbar__toggle svg {
      width: 20px;
      height: 20px;
    }

    .a11y-toolbar__panel {
      width: min(250px, calc(100vw - 2rem));
      bottom: calc(100% + 0.375rem);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .a11y-toolbar__toggle,
    .a11y-toolbar__toggle svg {
      transition: none;
    }
  }

  /* Remove legacy dialog styles as they are not used in this component */
</style>
